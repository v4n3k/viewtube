'use client';

import { PreviewUploadInput, VideoUploadInput } from '@/entities/video/ui';
import { Button, TextArea, TextField } from '@/shared/ui';
import { ChangeEvent, FormEvent, useEffect, useState } from 'react';
import { useUploadVideo } from '../../model';
import styles from './UploadVideoForm.module.css';

interface FormState {
	title: string;
	description: string;
	videoFile: File | null;
	previewFile: File | null;
}

const initialFormState: FormState = {
	title: '',
	description: '',
	videoFile: null,
	previewFile: null,
};

export const UploadVideoForm = () => {
	const [form, setForm] = useState(initialFormState);

	const { uploadVideo, isPending, isSuccess } = useUploadVideo();

	useEffect(() => {
		if (isSuccess) {
			setForm(initialFormState);
		}
	}, [isSuccess]);

	useEffect(() => {
		console.log(form);
	}, [form]);

	const { title, description, videoFile, previewFile } = form;

	const handleFormChange = (
		key: keyof FormState,
		e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
	) => {
		setForm(prev => ({ ...prev, [key]: e.target.value }));
	};

	const handleSubmit = (e: FormEvent<HTMLFormElement>) => {
		e.preventDefault();

		const formData = new FormData();

		formData.append('title', title);
		formData.append('description', description);
		if (videoFile) formData.append('videoFile', videoFile);
		if (previewFile) formData.append('previewFile', previewFile);

		uploadVideo(formData);
	};

	const handleVideoFileSelect = (file: File | null) => {
		setForm(prev => ({ ...prev, videoFile: file }));
	};

	const handlePreviewFileSelect = (file: File | null) => {
		setForm(prev => ({ ...prev, previewFile: file }));
	};

	return (
		<article className={styles.formContainer}>
			<h2 className={styles.title}>Upload Video</h2>
			<form className={styles.form} onSubmit={handleSubmit}>
				<div className={styles.uploadsContainer}>
					<VideoUploadInput
						initialFile={videoFile}
						onFileSelect={handleVideoFileSelect}
						placeholder='Upload video'
					/>

					<PreviewUploadInput
						initialImage={previewFile}
						onImageSelect={handlePreviewFileSelect}
						placeholder='Upload preview image'
					/>
				</div>

				<TextField
					type='text'
					value={title}
					onChange={e => handleFormChange('title', e)}
					placeholder='Title'
				/>
				<TextArea
					value={description}
					onChange={e => handleFormChange('description', e)}
					placeholder='Description'
				/>

				<Button className={styles.button} type='submit' isLoading={isPending}>
					Upload
				</Button>
			</form>
		</article>
	);
};

import { FileUpload } from '@/shared/ui';

export const PreviewUploadInput = ({
	onImageSelect,
	disabled,
	initialImage,
	placeholder,
}: {
	onImageSelect: (file: File | null) => void;
	disabled?: boolean;
	initialImage?: File | null;
	placeholder?: string;
}) => {
	const initialPreviewUrl =
		initialImage instanceof File ? URL.createObjectURL(initialImage) : null;

	return (
		<FileUpload
			onFileSelect={onImageSelect}
			accept='image/*'
			disabled={disabled}
			initialFile={initialImage}
			initialPreviewUrl={initialPreviewUrl}
			placeholder={placeholder}
			supportText='Supports JPG, PNG, GIF, WEBP'
			maxSize={50 * 1024 * 1024}
			showPreviewImage={true}
		/>
	);
};

'use client';

import clsx from 'clsx';
import { ChangeEvent, useEffect, useRef, useState } from 'react';
import styles from './FileUpload.module.css';

interface FileUploadProps {
	onFileSelect: (file: File | null) => void;
	accept: string;
	disabled?: boolean;
	initialFile?: File | null;
	initialPreviewUrl?: string | null;
	placeholder?: string;
	supportText?: string;
	maxSize?: number;
	showPreviewImage?: boolean;
}

export const FileUpload = ({
	onFileSelect,
	accept,
	disabled = false,
	initialFile = null,
	initialPreviewUrl = null,
	placeholder = 'Click or drag file to upload',
	supportText = 'Supported formats',
	maxSize = 100 * 1024 * 1024,
	showPreviewImage = false,
}: FileUploadProps) => {
	const [selectedFile, setSelectedFile] = useState<File | null>(initialFile);
	const [previewUrl, setPreviewUrl] = useState<string | null>(
		initialPreviewUrl
	);
	const [error, setError] = useState<string | null>(null);
	const fileInputRef = useRef<HTMLInputElement>(null);

	useEffect(() => {
		setSelectedFile(initialFile);
	}, [initialFile]);

	useEffect(() => {
		if (initialPreviewUrl) {
			setPreviewUrl(initialPreviewUrl);
		} else if (!initialFile) {
			setPreviewUrl(null);
		}
	}, [initialPreviewUrl]);

	const formatFileSize = (bytes: number): string => {
		if (bytes === 0) return '0 Bytes';

		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));

		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	};

	const handleFileChange = (e: ChangeEvent<HTMLInputElement>) => {
		const file = e.target.files?.[0] || null;
		setError(null);
		setPreviewUrl(null);

		if (!file) {
			setSelectedFile(null);
			onFileSelect(null);
			return;
		}

		if (!file.type.match(accept.replace('*', '.*'))) {
			setError('Invalid file type');
			return;
		}

		if (file.size > maxSize) {
			setError(`File size exceeds ${formatFileSize(maxSize)}`);
			return;
		}

		if (file.type.startsWith('image/')) {
			const objectUrl = URL.createObjectURL(file);
			setPreviewUrl(objectUrl);

			return () => URL.revokeObjectURL(objectUrl);
		}

		setSelectedFile(file);
		onFileSelect(file);
	};

	const handleRemove = () => {
		if (previewUrl) {
			URL.revokeObjectURL(previewUrl);
		}
		setPreviewUrl(null);
		setSelectedFile(null);
		setError(null);
		onFileSelect(null);
		if (fileInputRef.current) {
			fileInputRef.current.value = '';
		}
	};

	const handleClick = () => {
		if (!disabled && fileInputRef.current) {
			fileInputRef.current.click();
		}
	};

	const isImage =
		(selectedFile && selectedFile.type.startsWith('image/')) || previewUrl;

	return (
		<div className={styles.container}>
			<input
				ref={fileInputRef}
				type='file'
				accept={accept}
				onChange={handleFileChange}
				disabled={disabled}
				className={styles.fileInput}
			/>
			<div
				className={clsx(styles.uploadArea, { [styles.disabled]: disabled })}
				onClick={handleClick}
			>
				{isImage && showPreviewImage ? (
					<div className={styles.previewWrapper}>
						<img
							src={
								previewUrl ||
								(selectedFile ? URL.createObjectURL(selectedFile) : '')
							}
							alt='Preview'
							className={styles.previewImage}
							onLoad={() => {
								if (previewUrl) URL.revokeObjectURL(previewUrl);
							}}
						/>
						<button
							type='button'
							className={styles.removeButton}
							onClick={e => {
								e.stopPropagation();
								handleRemove();
							}}
						>
							×
						</button>
					</div>
				) : selectedFile ? (
					<div className={styles.fileInfo}>
						<p className={styles.fileName}>{selectedFile.name}</p>
						<p className={styles.fileSize}>
							{formatFileSize(selectedFile.size)}
						</p>
						<button
							type='button'
							className={styles.removeButton}
							onClick={e => {
								e.stopPropagation();
								handleRemove();
							}}
						>
							×
						</button>
					</div>
				) : (
					<div className={styles.placeholder}>
						<p className={styles.placeholderText}>{placeholder}</p>
						<p className={styles.supportText}>{supportText}</p>
					</div>
				)}
			</div>
			{error && <div className={styles.error}>{error}</div>}
		</div>
	);
};

previewFile в form не меняется при выборе превью для видео (оно всегда null)